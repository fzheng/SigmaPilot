<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hyperliquid BTC Perp Tracker</title>
    <style>
      :root {
        --bg: #0f1218;
        --fg: #e6e6e6;
        --muted: #a0a7b4;
        --accent: #2ec4b6;
        --warn: #ff9f1a;
        --bad: #ff4d4f;
        --good: #2ecc71;
      }
      body {
        margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: var(--bg); color: var(--fg);
      }
      .wrap { max-width: 920px; margin: 32px auto; padding: 0 16px; }
      h1 { font-size: 20px; margin: 0 0 16px; }
      .card { background: #151a23; border: 1px solid #202736; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
      input[type=text] { width: 360px; padding: 8px 10px; border-radius: 6px; border: 1px solid #2a3142; background: #0d1117; color: var(--fg); }
      button { padding: 8px 12px; border-radius: 6px; border: 1px solid #2a3142; background: #1b2130; color: var(--fg); cursor: pointer; margin-left: 8px; }
      button:hover { border-color: #39445c; }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 8px; border-bottom: 1px solid #252c3c; text-align: left; }
      th { color: var(--muted); font-weight: 600; }
      .muted { color: var(--muted); }
      .score { font-weight: 600; }
      .score.positive { color: var(--good); }
      .score.negative { color: var(--bad); }
      .small { font-size: 12px; }
      .row { display: flex; gap: 8px; align-items: center; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Hyperliquid BTC Perp Tracker</h1>

      <div class="card">
        <div class="row">
          <input id="addrInput" type="text" placeholder="Enter Hyperliquid address (0x...)" />
          <button id="addBtn">Add address</button>
          <span id="addMsg" class="muted small"></span>
        </div>
      </div>

      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;">
          <h3 style="margin:0">Tracked addresses</h3>
          <button id="pollNowBtn" title="Trigger an immediate server poll">Refresh now</button>
        </div>
        <table>
          <thead>
            <tr><th>Address</th><th style="width:120px;">Actions</th></tr>
          </thead>
          <tbody id="addrTbody"></tbody>
        </table>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Recommendations</h3>
        <div id="recs"></div>
        <div class="muted small" id="lastUpdated"></div>
      </div>
    </div>

    <script>
      const addrInput = document.getElementById('addrInput');
      const addBtn = document.getElementById('addBtn');
      const addMsg = document.getElementById('addMsg');
      const addrTbody = document.getElementById('addrTbody');
      const recsDiv = document.getElementById('recs');
      const lastUpdated = document.getElementById('lastUpdated');
      const pollNowBtn = document.getElementById('pollNowBtn');

      async function fetchAddresses() {
        const r = await fetch('/api/addresses');
        return (await r.json()).addresses || [];
      }

      async function fetchRecs() {
        const r = await fetch('/api/recommendations');
        return (await r.json()).recommendations || [];
      }

      function renderAddresses(addresses) {
        addrTbody.innerHTML = '';
        addresses.forEach(a => {
          const tr = document.createElement('tr');
          const tdA = document.createElement('td');
          const link = document.createElement('a');
          link.href = '#';
          link.textContent = a;
          link.addEventListener('click', (e) => { e.preventDefault(); showHoldings(a); });
          tdA.appendChild(link);

          const tdActions = document.createElement('td');
          const rm = document.createElement('button');
          rm.textContent = 'Remove';
          rm.addEventListener('click', async () => {
            await removeAddress(a);
            await refresh();
          });
          tdActions.appendChild(rm);

          tr.appendChild(tdA);
          tr.appendChild(tdActions);
          addrTbody.appendChild(tr);
        });
      }

      function renderRecs(recs) {
        recsDiv.innerHTML = '';
        recs.forEach(r => {
          const row = document.createElement('div');
          row.style.marginBottom = '10px';
          const scoreClass = r.score > 0 ? 'positive' : (r.score < 0 ? 'negative' : '');
          row.innerHTML = `
            <div class="small muted">${r.timestamp}</div>
            <div><span class="score ${scoreClass}">Score: ${r.score.toFixed(2)}</span> — ${r.text}</div>
            <div class="small muted">Address: ${r.address} • Exposure: ${r.exposureBtc.toFixed(4)} BTC • Price: $${r.priceUsd.toFixed(0)}</div>
          `;
          recsDiv.appendChild(row);
        });
        lastUpdated.textContent = recs.length ? `Last updated: ${new Date().toLocaleTimeString()}` : '';
      }

      async function refresh() {
        try {
          const [addrs, recs] = await Promise.all([fetchAddresses(), fetchRecs()]);
          renderAddresses(addrs);
          renderRecs(recs);
        } catch (e) {
          console.error('refresh failed', e);
        }
      }

      addBtn.addEventListener('click', async () => {
        const address = (addrInput.value || '').trim();
        addMsg.textContent = '';
        if (!address) return;
        try {
          const r = await fetch('/api/addresses', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address })
          });
          if (!r.ok) {
            const j = await r.json().catch(() => ({}));
            addMsg.textContent = j.error || 'Failed to add address';
            return;
          }
          addrInput.value = '';
          addMsg.textContent = 'Added';
          setTimeout(() => (addMsg.textContent = ''), 1200);
          await refresh();
        } catch (e) {
          addMsg.textContent = 'Network error';
        }
      });

      pollNowBtn.addEventListener('click', async () => {
        pollNowBtn.disabled = true;
        try {
          await fetch('/api/poll-now', { method: 'POST' });
          await refresh();
        } finally {
          pollNowBtn.disabled = false;
        }
      });

      async function removeAddress(address) {
        await fetch(`/api/addresses/${encodeURIComponent(address)}`, { method: 'DELETE' });
      }

      // Modal for holdings
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.inset = '0';
      modal.style.display = 'none';
      modal.style.background = 'rgba(0,0,0,0.5)';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      const modalCard = document.createElement('div');
      modalCard.style.background = '#11161f';
      modalCard.style.border = '1px solid #2a3142';
      modalCard.style.borderRadius = '8px';
      modalCard.style.padding = '16px';
      modalCard.style.width = '520px';
      modalCard.style.maxWidth = '90vw';
      modalCard.innerHTML = '<div class="row" style="justify-content:space-between;"><strong>Perp holdings</strong><button id="modalClose">Close</button></div><div id="modalBody" class="small" style="margin-top:8px;"></div>';
      modal.appendChild(modalCard);
      document.body.appendChild(modal);
      document.getElementById('modalClose').addEventListener('click', () => { modal.style.display = 'none'; });

      async function showHoldings(address) {
        modal.style.display = 'flex';
        const body = modal.querySelector('#modalBody');
        body.textContent = 'Loading...';
        try {
          const r = await fetch(`/api/positions/${encodeURIComponent(address)}`);
          const j = await r.json();
          const positions = j.positions || [];
          if (!positions.length) {
            body.textContent = 'No open perp positions.';
            return;
          }
          const tbl = document.createElement('table');
          tbl.style.width = '100%';
          tbl.style.borderCollapse = 'collapse';
          tbl.innerHTML = '<thead><tr><th>Symbol</th><th>Side</th><th>Size</th><th>Entry</th><th>Lev</th></tr></thead>';
          const tb = document.createElement('tbody');
          positions.forEach(p => {
            const tr = document.createElement('tr');
            const side = p.size > 0 ? 'Long' : 'Short';
            tr.innerHTML = `
              <td>${p.symbol}</td>
              <td>${side}</td>
              <td>${Math.abs(p.size).toFixed(4)}</td>
              <td>${p.entryPriceUsd ? ('$' + Number(p.entryPriceUsd).toFixed(0)) : '-'}</td>
              <td>${p.leverage ? Number(p.leverage).toFixed(1) + 'x' : '-'}</td>
            `;
            Array.from(tr.children).forEach(td => td.style.padding = '6px');
            tb.appendChild(tr);
          });
          tbl.appendChild(tb);
          body.innerHTML = '';
          body.appendChild(tbl);
        } catch (e) {
          body.textContent = 'Failed to load holdings.';
        }
      }

      // Initial load and polling every 10s
      refresh();
      setInterval(refresh, 10_000);
    </script>
  </body>
  </html>
